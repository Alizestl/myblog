<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Troubleshooting an infinite redirect error | Talk is cheap.</title>
  <link rel="stylesheet" href="/css/fonts/Chinese-normal-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/ChineseMono-normal-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/Chinese-italic-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/Chinese-normal-bold.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="记一次无限重定向排查">
  
  
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox-1.3.4.css">
  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div id="nav-outer">
  <nav id="main-nav" class="outer">
    <a id="main-nav-toggle" class="nav-icon"></a>
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
    <div class="main-nav-space-between"></div>
    
  </nav>
</div>
<div id="header-title">
  <h1 id="logo-wrap">
    <a href="/" id="logo">Talk is cheap.</a>
  </h1>
  
</div>

      <div id="content" class="outer">
        <section id="main"><article id="post-Troubleshooting-an-infinite-redirect-error" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/28/Troubleshooting-an-infinite-redirect-error/" class="article-date">
  <time class="dt-published" datetime="2025-01-28T10:07:52.000Z" itemprop="datePublished">2025-01-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Troubleshooting an infinite redirect error
    </h1>
  

      </header>
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言与基本情况"><a href="#前言与基本情况" class="headerlink" title="前言与基本情况"></a>前言与基本情况</h1><p>最近DeepSeek R1开源引起一股热潮<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>以至于DeepSeek官网开始限制注册<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span>今天上午的时候发现+86手机号无法注册<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>内心腹诽 <span class="bd-box"><h-char class="bd bd-beg"><h-inner>”</h-inner></h-char></span>这是在限流国内<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>尽力给老外展示军火么<span class="bd-box"><h-char class="bd bd-end"><h-inner>“</h-inner></h-char><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>没抱着希望<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>尝试用Gmail登录居然成功了<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span>不由得感慨<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>看来DeepSeek最近是很忙啊<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>随即充值了20CNY的DeepSeek Token<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>掏出最近7$买的vps<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>开始搭建私有化AI<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>搭建过程参考的是这篇<a target="_blank" rel="noopener" href="https://blog.xzbzq.com/30789.html">博客</a><span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>选用的框架是Next-Chat-GPT<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>早在23年的时候<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>我就接触过这个开源项目<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>后来这个项目的开发者把它卖掉了<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>或许这就是做开源养活自己吧<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>由于之前是在Vercel上部署<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>这次想尝试一下新的方式<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>于是便在VPS上用docker compose部署<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>参考上面的博客链接即可<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>总之<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>设备的基本情况<span class="bd-box"><h-char class="bd bd-beg"><h-inner>：</h-inner></h-char></span>域名和VPS是海外域名<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>域名解析是放在赛博菩萨 Cloudflare 上的<span class="bd-box"><h-char class="bd bd-end"><h-inner>（</h-inner></h-char></span>这是伏笔<span class="bd-box"><h-char class="bd bd-beg"><h-inner>）</h-inner></h-char></span></p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>在部署Nginx<span class="bd-box"><h-char class="bd bd-beg"><h-inner>、</h-inner></h-char></span>配置certbot获取SSL证书<span class="bd-box"><h-char class="bd bd-beg"><h-inner>、</h-inner></h-char></span><code>docker compose up -d</code>启动容器和cf添加A记录解析后<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>我尝试ip访问是成功的<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>但域名访问失败<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p><img src="/../images/Troubleshooting-an-infinite-redirect-error/brower_issue.png"></p>
<p>尝试curl域名<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>发现HTTP和HTTPS的回显状态码均为301<span class="bd-box"><h-char class="bd bd-beg"><h-inner>：</h-inner></h-char></span></p>
<p><img src="/../images/Troubleshooting-an-infinite-redirect-error/issue.jpg"></p>
<h1 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h1><p>其实症状到这里很明显了<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>是无限重定向导致的域名访问不正常<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span>那么病因是什么呢<span class="bd-box"><h-char class="bd bd-beg"><h-inner>？</h-inner></h-char></span></p>
<p>搜索引擎给出的大部分答案是Nginx配置错误<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>我的Nginx配置文件如下<span class="bd-box"><h-char class="bd bd-beg"><h-inner>：</h-inner></h-char></span></p>
<p><img src="/../images/Troubleshooting-an-infinite-redirect-error/nginx_config.png"></p>
<p>在确认配置与docker映射端口等均无误后<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>我想到我的博客vps没有配置certbot<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>但也支持HTTPS<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>当初部署的时候也只是通过cf做的域名解析<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span>于是我便是怀疑<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>是否是cf这边配置出了问题<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>打开cf dashboard<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>仔细阅读cf的SSL&#x2F;TLS Configure encryption mode后<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>我弄清楚了问题的根源<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>以下是cf的五种SSL&#x2F;TLS Configure encryption mode<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>而我一开始选择的是Flexible mode</p>
<p><img src="/../images/Troubleshooting-an-infinite-redirect-error/cf_config.png"></p>
<p>Flexible mode的通信逻辑是这样的<span class="bd-box"><h-char class="bd bd-beg"><h-inner>：</h-inner></h-char></span></p>
<ul>
<li>在 Flexible 模式下<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>Cloudflare 只加密用户到 Cloudflare 之间的通信<span class="bd-box"><h-char class="bd bd-end"><h-inner>（</h-inner></h-char></span>HTTPS<span class="bd-box"><h-char class="bd bd-beg"><h-inner>）</h-inner></h-char><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>而 Cloudflare 到源服务器之间的通信是通过 HTTP 进行的<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
</ul>
<p>因此<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>如果VPS配置了 SSL 证书并强制 HTTPS<span class="bd-box"><h-char class="bd bd-end"><h-inner>（</h-inner></h-char></span>例如通过 <code>.htaccess</code> 或 Nginx&#x2F;Apache 配置<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>这里是Nginx配置<span class="bd-box"><h-char class="bd bd-beg"><h-inner>）</h-inner></h-char><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>那么VPS会要求所有请求必须通过 HTTPS 访问<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>
<p>咋一听感觉没什么问题是不是<span class="bd-box"><h-char class="bd bd-beg"><h-inner>？</h-inner></h-char></span></p>
<p>但上面所示的Nginx配置下<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>会产生<strong>重定向闭环</strong><span class="bd-box"><h-char class="bd bd-beg"><h-inner>：</h-inner></h-char></span></p>
<ul>
<li>用户通过 HTTPS 访问你的网站<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>请求到达 Cloudflare<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
<li>Cloudflare 以 HTTP 方式将请求转发到源服务器<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
<li>源服务器检测到请求是 HTTP<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>会强制重定向到 HTTPS<span class="bd-box"><h-char class="bd bd-end"><h-inner>（</h-inner></h-char></span>因为你在源服务器上配置了 SSL 证书<span class="bd-box"><h-char class="bd bd-beg"><h-inner>）</h-inner></h-char><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
<li>重定向后的 HTTPS 请求再次到达 Cloudflare<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span><strong>Cloudflare 仍然以 HTTP 方式转发到源服务器</strong><span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
<li>源服务器再次检测到 HTTP 请求<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>继续重定向到 HTTPS<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
<li>这个过程会无限循环<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>导致重定向闭环<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></li>
</ul>
<p>所以<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>有两种解决办法<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>一是将cf mode修改为Full 或 Full (Strict)<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>二是修改Nginx配置在源服务器上禁用强制 HTTPS<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>根据具体需求选择适合的解决方案即可<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span>如下图<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>重新curl也显示正常了<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>HTTPS不会301</p>
<p><img src="/../images/Troubleshooting-an-infinite-redirect-error/resolved.png"></p>
<p>哦对<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>今天是除夕<span class="bd-box"><h-char class="bd bd-beg"><h-inner>，</h-inner></h-char></span>2025快乐<span class="bd-box"><h-char class="bd bd-beg"><h-inner>。</h-inner></h-char></span></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ops/" rel="tag">Ops</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/03/15/wireshark_tcp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Wireshark抓tcp包实践与深入了解存活机制
        
      </div>
    </a>
  
  
    <a href="/2024/12/29/2024AS/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          2024 年度总结
        
      </div>
    </a>
  
</nav>

  
</article>


</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <p></p>
      
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="/js/clipboard.min.js"></script>
<script src="/js/jquery-1.4.3.min.js"></script>

<script src="/fancybox/jquery.fancybox-1.3.4.pack.js"></script>


<script src="/js/script.js"></script>






<script>
  MathJax = {
    options: {
      enableMenu: false
    },
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
    }
  };
</script>
<!-- <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
    CommonHTML: {
      linebreaks: false
    }
  });
  </script> -->
<script type="text/javascript" id="MathJax-script" async
  src="/mathjax/tex-chtml.js">
</script>
<!-- <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML">
</script> -->

  </div>
</body>
</html>